services:
  # Main Application (Unified API Gateway)
  app:
    build: .
    runtime: nvidia
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # Override for Docker-specific database URL (use Docker service name)
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/pptx_tts
      - REDIS_URL=redis://redis:6379
      # Default values for optional variables
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-changeme-jwt-secret}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRE_MINUTES=${JWT_EXPIRE_MINUTES:-1440}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-10}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS:-300}
      - ANALYTICS_ENABLED=${ANALYTICS_ENABLED:-true}
      - TELEMETRY_SAMPLE_RATE=${TELEMETRY_SAMPLE_RATE:-0.1}
      - WEBSOCKET_MAX_CONNECTIONS=${WEBSOCKET_MAX_CONNECTIONS:-100}
      - WEBSOCKET_HEARTBEAT_INTERVAL=${WEBSOCKET_HEARTBEAT_INTERVAL:-30}
      - MEDIA_ROOT=${MEDIA_ROOT:-/app/media}
      - VOICE_PROFILE_STORAGE_DIR=${VOICE_PROFILE_STORAGE_DIR:-/app/voice_profiles}
      - ANALYTICS_EXPORT_DIR=${ANALYTICS_EXPORT_DIR:-/app/analytics_exports}
      - IMAGE_ANALYSIS_PROVIDER=${IMAGE_ANALYSIS_PROVIDER:-azure}
      - USE_AZURE_OPENAI=${USE_AZURE_OPENAI:-true}
      - USE_AZURE_OPENAI_VISION=${USE_AZURE_OPENAI_VISION:-true}
      - DEBUG=${DEBUG:-false}
      - CHATTERBOX_API_BASE=${CHATTERBOX_API_BASE:-http://chatterbox-tts:4123}

    volumes:
      - ./:/app
      - ./media:/app/media
      - ./voice_profiles:/app/voice_profiles
      - ./analytics_exports:/app/analytics_exports
      - ./.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      chatterbox-tts:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL Database
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=pptx_tts
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - ./.env:/app/.env
      - postgres_data:/var/lib/postgresql/data
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  chatterbox-tts:
    build:
      context: ./chatterbox_api
    runtime: nvidia
    ports:
      - "4123:4123"
    environment:
      - EXAGGERATION=${CHATTERBOX_EXAGGERATION:-0.5}
      - CFG_WEIGHT=${CHATTERBOX_CFG_WEIGHT:-0.5}
      - TEMPERATURE=${CHATTERBOX_TEMPERATURE:-0.8}
      - VOICE_SAMPLE_PATH=${CHATTERBOX_VOICE_SAMPLE_PATH:-/app/voice_profiles/default.wav}
      - LANGUAGE=${CHATTERBOX_LANGUAGE:-el}
      - DEVICE=cuda
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ./voice_profiles:/app/voice_profiles
      - ./media:/app/media
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4123/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

networks:
  pptx-network:
    driver: bridge

volumes:
  postgres_data:
  media_storage:
  voice_profile_storage:
  analytics_exports:
