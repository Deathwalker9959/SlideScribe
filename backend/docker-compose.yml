version: '3.8'

services:
  # AI Text Refinement Service
  ai-refinement:
    build: ./services/ai-refinement
    ports:
      - "8001:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    volumes:
      - ./shared:/app/shared
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Azure TTS Service
  tts-service:
    build: ./services/tts-service
    ports:
      - "8002:8000"
    environment:
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - DEFAULT_VOICE=${DEFAULT_VOICE}
      - DEFAULT_SPEED=${DEFAULT_SPEED}
      - DEFAULT_PITCH=${DEFAULT_PITCH}
    volumes:
      - ./shared:/app/shared
      - ./media:/app/media
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Subtitle Service
  subtitle-service:
    build: ./services/subtitle-service
    ports:
      - "8003:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./shared:/app/shared
      - ./media:/app/media
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped

  # Subtitle Service
  subtitle-service:
    build: ./services/subtitle-service
    ports:
      - "8003:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SUBTITLE_DEFAULT_LANGUAGE=${SUBTITLE_DEFAULT_LANGUAGE}
      - SUBTITLE_MAX_CHARS_PER_LINE=${SUBTITLE_MAX_CHARS_PER_LINE}
      - SUBTITLE_MAX_LINES=${SUBTITLE_MAX_LINES}
    volumes:
      - ./shared:/app/shared
      - ./media:/app/media
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Analytics Service
  analytics-service:
    build: ./services/analytics
    ports:
      - "8005:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - ANALYTICS_ENABLED=${ANALYTICS_ENABLED}
      - ANALYTICS_EXPORT_TTL_HOURS=${ANALYTICS_EXPORT_TTL_HOURS}
      - ANALYTICS_EXPORT_DIR=${ANALYTICS_EXPORT_DIR}
      - TELEMETRY_SAMPLE_RATE=${TELEMETRY_SAMPLE_RATE}
    volumes:
      - ./shared:/app/shared
      - ./analytics_exports:/app/analytics_exports
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Voice Profile Service
  voice-profile-service:
    build: ./services/voice-profiles
    ports:
      - "8006:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - VOICE_PROFILE_STORAGE_DIR=${VOICE_PROFILE_STORAGE_DIR}
      - VOICE_PROFILE_MAX_SIZE=${VOICE_PROFILE_MAX_SIZE}
      - VOICE_PROFILE_CACHE_TTL=${VOICE_PROFILE_CACHE_TTL}
    volumes:
      - ./shared:/app/shared
      - ./voice_profiles:/app/voice_profiles
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Narration Orchestrator
  narration-orchestrator:
    build: ./services/narration
    ports:
      - "8007:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - AI_REFINEMENT_URL=http://ai-refinement:8000
      - TTS_SERVICE_URL=http://tts-service:8000
      - SUBTITLE_SERVICE_URL=http://subtitle-service:8000
      - ANALYTICS_SERVICE_URL=http://analytics-service:8000
      - VOICE_PROFILE_SERVICE_URL=http://voice-profile-service:8000
      - WEBSOCKET_MAX_CONNECTIONS=${WEBSOCKET_MAX_CONNECTIONS}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS}
    volumes:
      - ./shared:/app/shared
      - ./media:/app/media
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - ai-refinement
      - tts-service
      - subtitle-service
      - analytics-service
      - voice-profile-service

  # Main Application (Unified API Gateway)
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      # Database and Cache
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}

      # AI Services
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}

      # TTS Services
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION}

      # Security
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - JWT_EXPIRE_MINUTES=${JWT_EXPIRE_MINUTES}

      # Performance
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS}

      # Analytics
      - ANALYTICS_ENABLED=${ANALYTICS_ENABLED}
      - TELEMETRY_SAMPLE_RATE=${TELEMETRY_SAMPLE_RATE}

      # WebSocket
      - WEBSOCKET_MAX_CONNECTIONS=${WEBSOCKET_MAX_CONNECTIONS}
      - WEBSOCKET_HEARTBEAT_INTERVAL=${WEBSOCKET_HEARTBEAT_INTERVAL}

      # File Storage
      - MEDIA_ROOT=${MEDIA_ROOT}
      - VOICE_PROFILE_STORAGE_DIR=${VOICE_PROFILE_STORAGE_DIR}
      - ANALYTICS_EXPORT_DIR=${ANALYTICS_EXPORT_DIR}

      # CORS
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    volumes:
      - ./shared:/app/shared
      - ./media:/app/media
      - ./voice_profiles:/app/voice_profiles
      - ./analytics_exports:/app/analytics_exports
      - ../.env:/app/.env
    networks:
      - pptx-network
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL Database
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=pptx_tts
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - ../.env:/app/.env
      - postgres_data:/var/lib/postgresql/data
    networks:
      - pptx-network
    restart: unless-stopped

  # Redis for caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - pptx-network
    restart: unless-stopped

networks:
  pptx-network:
    driver: bridge

volumes:
  postgres_data:
  media_storage:
  voice_profile_storage:
  analytics_exports:
